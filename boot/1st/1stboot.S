! <1stboot.s> --- ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ–ãƒ¼ãƒˆ.ä¸€ç•ªæœ€åˆã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹.
!
! $Date: 1999/12/23 17:54:17 $
! $Log: 1stboot.S,v $
! Revision 1.2  1999/12/23 17:54:17  kishida0
! loader $B$N0LCV$r(B 1st loader $B$K$&$a$`MM$K%(%s%H%j$rDI2C$7$?(B
!
! Revision 1.1  1999/03/15 02:10:52  monaka
! renamed some asm files included cpp macros. *.s was obsolute.
!
! Revision 1.7  1998/12/09 00:01:27  monaka
! Minor changed. (This is not bug fix)
!
! Revision 1.6  1998/11/20 08:02:16  monaka
! *** empty log message ***
!
! Revision 1.5  1998/05/23 15:29:32  night
! è—¤æ°¸ã•ã‚“ãƒã‚·ãƒ³ç”¨ã®å¤‰æ›´ã€‚
! (ãŸã ã—ã€ã“ã®å¤‰æ›´ã§ã¯ã€è—¤æ°¸ã•ã‚“ãƒã‚·ãƒ³ã§ã¯ã†ã¾ãå‹•ã‹ãªã‹ã£ãŸ)
!
! Revision 1.4  1996/07/06 13:10:58  night
! 2nd boot ã«å‡¦ç†ã‚’ç§»è¡Œã™ã‚‹å‰ã« 1 ç§’é–“ã® delay ã‚’ç½®ã„ãŸã€‚
!
# Revision 1.3  1996/05/11  14:36:41  night
# 1stboot çµ‚äº†æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
#
# Revision 1.2  1996/05/11  14:22:19  night
# 2nd boot ã®æƒ…å ±ãŒå…¥ã£ãŸã‚»ã‚¯ã‚¿ã‚’å¤‰æ›´(1 -> 2)
#
# Revision 1.1  1996/05/05  14:11:59  night
# 1st boot ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã€‚
# BIOS ã«ã‚ˆã‚Š FD ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã€2nd boot ã‚’èª­ã¿è¾¼ã‚€ã€‚
#
!
! Discription
!	æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€BTRON/386 ã®ã‚«ãƒ¼ãƒãƒ«ãƒ­ãƒ¼ãƒ‰ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã‚ã‚‹ã€‚
!
!	ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€ï¼¦ï¼¤ã‹ã‚‰ãƒ–ãƒ¼ãƒˆã™ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¦ã„ã‚‹ã€‚
!	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
!
!	ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒï¼©ï¼°ï¼¬ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸæ™‚ã€ãƒ¬ã‚¸ã‚¹ã‚¿é¡ã®çŠ¶æ…‹ã¯æ¬¡ã®
!	ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
!
!	AX,BX,CX,DX			ä¸å®š
!
!	ãƒ­ãƒ¼ãƒ‰ã‚¢ãƒ‰ãƒ¬ã‚¹	ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ	0x07C0
!			ã‚ªãƒ•ã‚»ãƒƒãƒˆ	0x0000
!	ãƒ­ãƒ¼ãƒ‰ã‚µã‚¤ã‚º			512 ãƒã‚¤ãƒˆ
!
! å‡¦ç†å†…å®¹
!
!	è‡ªåˆ†è‡ªèº«ã‚’ã‚³ãƒ”ãƒ¼ (0x07C0 -> 0x70000)
!	2nd BOOT æƒ…å ±ã‚’ãƒ­ãƒ¼ãƒ‰
!	2nd BOOT æœ¬ä½“ã‚’ãƒ­ãƒ¼ãƒ‰ (GDT, IDT, Page table ã‚’å«ã‚€)
!	2nd BOOT ã®å…ˆé ­ã«ã‚¸ãƒ£ãƒ³ãƒ—
!

seg_2ndboot = 		0x0800
off_2ndboot = 		0x0000

seg_2ndboot_info =	0x7800
off_2ndboot_info =	0x0000
seg_size_info =		0x7800
off_size_info =		0x0000
seg_loadpoint =		0x0100		! loadpoint = 0x1000 
off_loadpoint =		0x0000
info_sector	=	2		! 512 bytes/sector
info_cylinder	=	0

.text
begtext:

.text

entry		first_boot

		.org	0x0000
first_boot:
		mov	ax,#0x07c0
		mov	ds,ax
		mov	ax,#0x7000
		mov	es,ax
		mov	cx,#512
		sub	si,si
		sub	di,di
		cld
		rep
		movsw
		jmpi	#restart, #0x7000

restart:
		mov	ax, #0x7000
		mov	es, ax
		mov	ss, ax
		mov	ds, ax
		mov	sp, #2048

		mov	bx, #message
		call	print
		call	read2ndboot			! 2nd boot ã®èª­ã¿è¾¼ã¿
		call	delay
!		call	kill_motor
		mov	ax, #seg_2ndboot		! 2nd boot ã®å‘¼ã³å‡ºã—
		push	ax
		mov	ax, #off_2ndboot
		push	ax
		reti

delay:
		mov	ax,#0x1000
		mov	bx,#0xffff
delay1:
		dec	bx
		jnz	delay1
		mov	bx,#1000
		dec	ax
		jnz	delay1
		ret

!
! stop motor.
!
kill_motor:
		push	dx
		mov	dx, #0x3f2
		xor	al, al
		outb
		pop	dx
		ret	
read2ndboot:	
		! BIOS ãŒä½¿ç”¨ã™ã‚‹ FD ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
		mov	cx,#0
		sub	si,si
		mov	fs,cx
		mov	bx,#0x78		! fs:dl ãŒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãªã‚‹
		push	ds
		seg fs
		lds	si,(bx)			! ds:si ãŒãƒ†ãƒ¼ãƒ–ãƒ«ã«å…¥ã‚Œã‚‹æƒ…å ±ã®ã‚³ãƒ”ãƒ¼å…ƒ

		mov	cl,#6			! copy 12 bytes
		cld
		push	di

		rep
		movsw

		pop	di
		pop	ds

		movb	4(di),*36		! patch sector count
	
		seg fs
		mov	(bx),di
		seg fs
		mov	2(bx),es
	
		! 2nd BOOT ã®æƒ…å ±ã‚’ãƒ­ãƒ¼ãƒ‰
		mov	bx, #boot2_message
		call	print
		mov	seg_addr, #seg_size_info
		mov	off_addr, #off_size_info
		movb	sector, *info_sector
		movb	cylinder, *info_cylinder
		call	readdisk

		! èª­ã¿å–ã£ãŸæƒ…å ±ã‚’ä½¿ã£ã¦FDã‹ã‚‰2nd BOOTæœ¬ä½“ã‚’èª­ã¿å–ã‚‹
		movb	sector, *3
		movb	cylinder, *0
		mov	seg_addr, #seg_loadpoint
		mov	off_addr, #off_loadpoint
		mov	ax, #seg_size_info
		mov	es, ax
		seg es
		mov	ax, off_size_info

load_loop:
!		call	print_dot
		cmp	ax, #0
		jz	loop_done

		cmpb	sector, #19		! ã‚»ã‚¯ã‚¿ç•ªå·ãŒ 19 ã®å ´åˆ
		jne	l2

		call	print_dot
		mov	sector, #1		! ã‚»ã‚¯ã‚¿ç•ªå·ã‚’1ã«æˆ»ã™
		incb	cylinder

l2:
		call	readdisk
		add	seg_addr, #0x0020	! 512 bytes/sector
		dec	ax
		incb	sector
		jmp	load_loop

loop_done:
!		mov	bx, #done_message
!		call	print
		ret
				


!
!	ä¸‹å—ã‘é–¢æ•°ç¾¤
!
!
! print --- æ–‡å­—åˆ—ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã™ã‚‹ã€‚
!
! å¼•æ•°ï¼š
!	bx	è¡¨ç¤ºã™ã‚‹æ–‡å­—åˆ—ã®ã‚¢ãƒ‰ãƒ¬ã‚¹
!		æ–‡å­—åˆ—ã¯ã€<é•·ã•>:1ãƒã‚¤ãƒˆ
!			  <æ–‡å­—åˆ—>:æœ€å¤§255ãƒã‚¤ãƒˆ
!		ã¨ãªã£ã¦ã„ã‚‹ã€‚
print:
		push	ax
		push	bx
		push	cx
		push	dx

		push	bx
		mov	ah,#0x03		! get cursor pos
		xor	bh,bh
		int	0x10
		pop	bx

		xor	cx, cx
		movb	cl, (bx)
		inc	bx
		mov	bp, bx
		mov	bx, #0x0007
		mov	ax, #0x1301
		int	0x10
		pop	dx
		pop	cx
		pop	bx
		pop	ax
		ret

print_dot:
		pusha
		mov	ax, #0xe2e		! '.'
		int	0x10
		popa
		ret
		
!
!
!

!
!	fatal --- æ’ä¹…çš„ãªå¤±æ•—! ç„¡é™ãƒ«ãƒ¼ãƒ—ã«å…¥ã‚‹
!
fatal:
		mov	bx, #fatal_message
		call	print
fatal_loop:
		jmp	fatal_loop

!
!	disk io routines
!
! 	ãƒ‡ã‚£ã‚¹ã‚¯ã‹ã‚‰æŒ‡å®šã—ãŸã‚»ã‚¯ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã€‚
!	BIOS ãƒ«ãƒ¼ãƒãƒ³ 0x13 ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
!
readdisk:
		push	ax
		push	bx
		push	cx
		push	dx

!		xor	ah, ah			! reset FDC
!		xor	dl, dl			! ãƒ‰ãƒ©ã‚¤ãƒ–ç•ªå·
!		int	0x13
retry_reading:
		xor	dx, dx
		movb	al, cylinder
		shr	al, #1
		movb	ch, al			! ã‚·ãƒªãƒ³ãƒ€ç•ªå·ã®ã‚»ãƒƒãƒˆ

		movb	al, cylinder
		and	al, #0x01
		movb	dh, al			! ãƒ˜ãƒƒãƒ‰ç•ªå·ã®ã‚»ãƒƒãƒˆ

		movb	cl, sector		! ã‚»ã‚¯ã‚¿ç•ªå·ã®ã‚»ãƒƒãƒˆ

		mov	ax, seg_addr		! èª­ã¿è¾¼ã‚€å ´æ‰€ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå€¤
		mov	es, ax
		mov	bx, off_addr		! èª­ã¿è¾¼ã‚€å ´æ‰€ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆå€¤
		movb	al, #0x01
		movb	ah, #0x02
		int	0x13			! BIOS ã®å‘¼ã³å‡ºã—
		jc	fatal

		pop	dx
		pop	cx
		pop	bx
		pop	ax
		ret
bad_rt:
		! reset FDC
		xor	ah, ah
		xor	dl, dl
		int	0x13

		! Print error message
		mov	bx, #retry_message
		call	print

		jmp	retry_reading


seg_addr:	.word	0	! ãƒãƒƒãƒ•ã‚¡ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
off_addr:	.word	0	! ãƒãƒƒãƒ•ã‚¡ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ
cylinder:	.byte	0	! ã‚·ãƒªãƒ³ãƒ€ç•ªå·(ã“ã®ä¸­ã«ã¯ã€ãƒ˜ãƒƒãƒ‰ç•ªå·ã‚‚å«ã¾ã‚Œã‚‹)
sector:		.byte	0	! ã‚»ã‚¯ã‚¿ç•ªå·
fatal_message:	
		.byte	35
		.ascii	"can't read 2ndboot program from FD."


!
! 	ãƒ‡ãƒ¼ã‚¿ç¾¤ (ä¸»ã«æ–‡å­—åˆ—ã€‚ã€‚ã€‚)
!
message: 	.byte	28
		.ascii	"1st boot for btron/386(PC)"
		.byte   13, 10

message_dot:	.byte	1
		.ascii	"."

retry_message:	.byte	1
		.ascii	"e"

boot2_message:
		.byte   21
		.ascii	"loading 2nd boot..."
		.byte   13, 10

done_message:
		.byte   20
		.ascii	"loaded 2nd boot..."
		.byte	13, 10


seg_addr:	.word	0	! ãƒãƒƒãƒ•ã‚¡ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
off_addr:	.word	0	! ãƒãƒƒãƒ•ã‚¡ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ
cylinder:	.byte	0	! ã‚·ãƒªãƒ³ãƒ€ç•ªå·
sector:		.byte	0	! ã‚»ã‚¯ã‚¿ç•ªå·(ã“ã®ä¸­ã«ã¯ã€ãƒ˜ãƒƒãƒ‰ç•ªå·ã‚‚å«ã¾ã‚Œã‚‹)
! read_count:	.word	0	! èª­ã¿è¾¼ã‚€ãƒ–ãƒ­ãƒƒã‚¯æ•°(512 å˜ä½)
fatal_message:
		.byte	34
		.ascii	"can't read 2ndboot program from FD."
		.byte	0

.org    498
loader_offset:  .word 0xffff

.org	510
boot_mark:
		.word 0xAA55

.text
endtext:

!.data
!enddata:

!.bss
!endbss:

		end	
	

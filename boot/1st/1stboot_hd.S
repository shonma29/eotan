!
!
! <1stboot.s> --- ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ–ãƒ¼ãƒˆ.ä¸€ç•ªæœ€åˆã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹.
!
! $Header: /usr/local/src/master/B-Free/Program/btron-pc/boot/1st/1stboot_hd.S,v 1.2 1999/12/23 17:54:18 kishida0 Exp $
!
! $Log: 1stboot_hd.S,v $
! Revision 1.2  1999/12/23 17:54:18  kishida0
! loader $B$N0LCV$r(B 1st loader $B$K$&$a$`MM$K%(%s%H%j$rDI2C$7$?(B
!
! Revision 1.1  1999/03/15 02:10:54  monaka
! renamed some asm files included cpp macros. *.s was obsolute.
!
! Revision 1.5  1998/06/11 14:37:24  night
! 10ãƒ“ãƒƒãƒˆã‚ã‚‹ã‚·ãƒªãƒ³ãƒ€ç•ªå·ã®ä¸Šä½ 2 ãƒ“ãƒƒãƒˆã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ãŸã€‚
! (ä»Šã¾ã§ã¯ 8 ãƒ“ãƒƒãƒˆã—ã‹æœ‰åŠ¹ã§ãªã‹ã£ãŸ)
! ã“ã®å¤‰æ›´ã®çµæœã€ã‚·ãƒªãƒ³ãƒ€æ•°ãŒ 256 ä»¥ä¸Šã® HD ã«å¯¾ã—ã¦ã‚‚ãƒ–ãƒ¼ãƒˆã§ã
! ã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚
!
! ãªãŠã€ã“ã“ã§æ›¸ã„ã¦ã„ã‚‹ã‚·ãƒªãƒ³ãƒ€æ•°ã¯ BIOS ã«ã¦å¤‰æ›ã•ã‚ŒãŸå¾Œã®å€¤ã€‚
!
! Revision 1.4  1998/02/23 15:34:23  night
! Dynabook ã® HD ã«åˆã‚ã›ã¦è¨­å®šã‚’å¤‰æ›´ã—ãŸã€‚
!
! Revision 1.3  1997/08/31 14:23:22  night
! ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒã®å¤‰æ›´ã«ä¼´ã„ã€HD ã®è¨­å®šæƒ…å ±ã‚’å¤‰æ›´ã—ãŸã€‚
!
! Revision 1.2  1997/06/29 13:12:16  night
! HD ã®ã‚¸ã‚ªãƒ¡ãƒˆãƒªæƒ…å ±ãŠã‚ˆã³ 2nd boot ã®å…¥ã£ã¦ã„ã‚‹ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³æƒ…å ±ã®å¤‰æ›´ã€‚
!
# Revision 1.1  1996/08/11  15:09:47  night
# æœ€åˆã®ç™»éŒ²
#
!
! Discription
!	æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€BTRON/386 ã®ã‚«ãƒ¼ãƒãƒ«ãƒ­ãƒ¼ãƒ‰ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã‚ã‚‹ã€‚
!
!	ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€ï¼¨ï¼¤ (IDE) ã‹ã‚‰ãƒ–ãƒ¼ãƒˆã™ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¦ã„ã‚‹ã€‚
!	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
!
!	ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒï¼©ï¼°ï¼¬ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸæ™‚ã€ãƒ¬ã‚¸ã‚¹ã‚¿é¡ã®çŠ¶æ…‹ã¯æ¬¡ã®
!	ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
!
!	AX,BX,CX,DX			ä¸å®š
!
!	ãƒ­ãƒ¼ãƒ‰ã‚¢ãƒ‰ãƒ¬ã‚¹	ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ	0x07C0
!			ã‚ªãƒ•ã‚»ãƒƒãƒˆ	0x0000
!	ãƒ­ãƒ¼ãƒ‰ã‚µã‚¤ã‚º			512 ãƒã‚¤ãƒˆ
!
! å‡¦ç†å†…å®¹
!
!	è‡ªåˆ†è‡ªèº«ã‚’ã‚³ãƒ”ãƒ¼ (0x07C0 -> 0x70000)
!	2nd BOOT æƒ…å ±ã‚’ãƒ­ãƒ¼ãƒ‰
!	2nd BOOT æœ¬ä½“ã‚’ãƒ­ãƒ¼ãƒ‰ (GDT, IDT, Page table ã‚’å«ã‚€)
!	2nd BOOT ã®å…ˆé ­ã«ã‚¸ãƒ£ãƒ³ãƒ—
!

seg_2ndboot = 		0x0800
off_2ndboot = 		0x0000

seg_2ndboot_info =	0x7800
off_2ndboot_info =	0x0000
seg_size_info =		0x7800
off_size_info =		0x0000
seg_loadpoint =		0x0100		! loadpoint = 0x1000
off_loadpoint =		0x0000

.text
begtext:

.text

entry		first_boot

		.org	0x0000
first_boot:
		mov	ax,#0x07c0
		mov	ds,ax
		mov	ax,#0x7000
		mov	es,ax
		mov	cx,#512
		sub	si,si
		sub	di,di
		cld
		rep
		movsw
		jmpi	#restart, #0x7000

restart:
		mov	ax, #0x7000
		mov	es, ax
		mov	ss, ax
		mov	ds, ax
		mov	sp, #2048

		mov	bx, #message
		call	print

		call	read2ndboot			! 2nd boot ã®èª­ã¿è¾¼ã¿

		mov	bx, #done_message
		call	print

		mov	ax, #seg_2ndboot		! 2nd boot ã®å‘¼ã³å‡ºã—
		push	ax
		mov	ax, #off_2ndboot
		push	ax
		reti

delay:
		mov	ax,#0x1000
		mov	bx,#0xffff
delay1:
		dec	bx
		jnz	delay1
		mov	bx,#1000
		dec	ax
		jnz	delay1
		ret
	
read2ndboot:
		! 2nd BOOT ã®æƒ…å ±ã‚’ãƒ­ãƒ¼ãƒ‰
		mov	bx, #boot2_message
		call	print

		mov	seg_addr, #seg_size_info
		mov	off_addr, #off_size_info

		movb	ah, #0x0d			! HD ã®ãƒªã‚»ãƒƒãƒˆ
		movb	dl, #0x80
		int	0x13

		movb	bl, s_sector			! ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®é–‹å§‹ä½ç½®ã‚’æŒ‡å®š
		movb	sector, bl			!

		mov	bx, s_cylinder			!
		mov	cylinder, bx			!

		movb	bl, s_head			!
		movb	head, bl			!
		inc	sector				! 1st boot ã®åˆ† (1 sector åˆ†ã‚’
		call	readdisk			! ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ)
		inc	sector

		! èª­ã¿å–ã£ãŸæƒ…å ±ã‚’ä½¿ã£ã¦FDã‹ã‚‰2nd BOOTæœ¬ä½“ã‚’èª­ã¿å–ã‚‹
		mov	seg_addr, #seg_loadpoint
		mov	off_addr, #off_loadpoint
		mov	ax, #seg_size_info
		mov	es, ax
		seg es
		mov	ax, off_size_info

load_loop:
		call	print_dot
		cmp	ax, #0
		jz	loop_done

		movb	bl, n_sector
		cmpb	sector, bl		! ã‚»ã‚¯ã‚¿ç•ªå·ãŒä¸Šé™ã‚’è¶ŠãˆãŸ
		jne	l2

		movb	sector, #1		! ã‚»ã‚¯ã‚¿ç•ªå·ã‚’1ã«æˆ»ã™
		inc	head			! æ¬¡ã®ãƒ˜ãƒƒãƒ‰ã¸ç§»å‹•

		movb	bl, n_head		! ãƒ˜ãƒƒãƒ‰ç•ªå·ãŒä¸Šé™ã‚’è¶ŠãˆãŸ
		cmp	head, bl		!
		jne	l3			
		inc	cylinder		! æ¬¡ã®ã‚·ãƒªãƒ³ãƒ€ã¸ç§»å‹•
		movb	head, #0		! ãƒ˜ãƒƒãƒ‰ã‚’ 0 ã«å¤‰æ›´

l3:
l2:
		call	readdisk
		add	seg_addr, #0x0020	! 512 bytes/sector
		dec	ax
		inc	sector
		jmp	load_loop

loop_done:
!		mov	bx, #done_message
!		call	print
		ret
				

!
!	ä¸‹å—ã‘é–¢æ•°ç¾¤
!
!
! print --- æ–‡å­—åˆ—ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã™ã‚‹ã€‚
!
! å¼•æ•°ï¼š
!	bx	è¡¨ç¤ºã™ã‚‹æ–‡å­—åˆ—ã®ã‚¢ãƒ‰ãƒ¬ã‚¹
!		æ–‡å­—åˆ—ã¯ã€<é•·ã•>:1ãƒã‚¤ãƒˆ
!			  <æ–‡å­—åˆ—>:æœ€å¤§255ãƒã‚¤ãƒˆ
!		ã¨ãªã£ã¦ã„ã‚‹ã€‚
print:
		push	ax
		push	bx
		push	cx
		push	dx

		push	bx
		mov	ah,#0x03		! get cursor pos
		xor	bh,bh
		int	0x10
		pop	bx

		xor	cx, cx
		movb	cl, (bx)
		inc	bx
		mov	bp, bx
		mov	bx, #0x0007
		mov	ax, #0x1301
		int	0x10
		pop	dx
		pop	cx
		pop	bx
		pop	ax
		ret

!
!
!
print_dot:
		push	ax
		mov	ax, #0xe2e		! '.'
		int	0x10
		pop	ax
		ret
		

!
!	fatal --- æ’ä¹…çš„ãªå¤±æ•—! ç„¡é™ãƒ«ãƒ¼ãƒ—ã«å…¥ã‚‹
!
fatal:
		j	fatal

!
!	disk io routines
!
! 	ãƒ‡ã‚£ã‚¹ã‚¯ã‹ã‚‰æŒ‡å®šã—ãŸã‚»ã‚¯ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã€‚
!	BIOS ãƒ«ãƒ¼ãƒãƒ³ 0x13 ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
!
readdisk:
		push	ax
		push	bx
		push	cx
		push	dx

		movb	dl, drive		! ãƒ‰ãƒ©ã‚¤ãƒ–ç•ªå·

		mov	ax, cylinder
		mov	ch, al			! ã‚·ãƒªãƒ³ãƒ€ç•ªå·ã®ã‚»ãƒƒãƒˆ(ä¸‹ä½ 8 ãƒ“ãƒƒãƒˆ)

		movb	al, head
		movb	dh, al			! ãƒ˜ãƒƒãƒ‰ç•ªå·ã®ã‚»ãƒƒãƒˆ

		movb	cl, sector		! ã‚»ã‚¯ã‚¿ç•ªå·ã®ã‚»ãƒƒãƒˆ
		shl	ah, 6			! ã‚»ã‚¯ã‚¿ç•ªå·ã®ä¸Šä½ 2 ãƒ“ãƒƒãƒˆã«ã‚·ãƒªãƒ³ãƒ€ç•ªå·ã®
		add	cl, ah			! ä¸Šä½ 2 ãƒ“ãƒƒãƒˆã‚’ã‚‚ã£ã¦ãã‚‹ã€‚

		mov	ax, seg_addr		! èª­ã¿è¾¼ã‚€å ´æ‰€ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå€¤
		mov	es, ax
		mov	bx, off_addr		! èª­ã¿è¾¼ã‚€å ´æ‰€ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆå€¤
		movb	al, #0x01
		movb	ah, #0x02
		int	0x13			! BIOS ã®å‘¼ã³å‡ºã—
		jc	fatal

		pop	dx
		pop	cx
		pop	bx
		pop	ax
		ret


! ãƒ†ãƒ³ãƒãƒ©ãƒªå¤‰æ•°ç¾¤
seg_addr:	.word	0	! ãƒãƒƒãƒ•ã‚¡ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
off_addr:	.word	0	! ãƒãƒƒãƒ•ã‚¡ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ
cylinder:	.word	0	! ã‚·ãƒªãƒ³ãƒ€ç•ªå·
sector:		.byte	0	! ã‚»ã‚¯ã‚¿ç•ªå·
head:		.byte	0	! ãƒ˜ãƒƒãƒ€ç•ªå·
fatal_message:	
		.byte	35
		.ascii	"can't read 2ndboot program from FD."


!
! 	ãƒ‡ãƒ¼ã‚¿ç¾¤ (ä¸»ã«æ–‡å­—åˆ—ã€‚ã€‚ã€‚)
!
message: 	.byte	28
		.ascii	"1st boot for btron/386(PC)"
		.byte   13, 10

!
!	read2ndboot --- 2nd BOOT ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ­ãƒ¼ãƒ‰
!
read2ndboot:
		ret

boot2_message:
		.byte   21
		.ascii	"loading 2nd boot..."
		.byte   13, 10

done_message:
		.byte   25
		.ascii	"loading 2nd boot...done"
		.byte	13, 10



fatal_message:
		.byte	34
		.ascii	"can't read 2ndboot program from FD."
		.byte	0

.org    498
loader_offset:	.word   0xffff

.org    500

.org	501
drive:		.byte 0x80	!  0x0 = FD
				! 0x80 = HD

! ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®é–‹å§‹ä½ç½®
.org	502
! HD ã®å ´åˆ (ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ 0)
s_cylinder:	.word 1
s_head:		.byte 2
s_sector:	.byte 3

.org	506
! HD ã® GEOMETORY æƒ…å ±
! ä¾‹ï¼šCylinder 255, Head 10, Sector 55
n_cylinder:	.word 4
n_head:		.byte 5		! old value is 16.
n_sector:	.byte 6		! ã‚»ã‚¯ã‚¿ã ã‘ã¯ã€æœ€å¤§æ•° + 1 ã«ã™ã‚‹ã€‚

.org	510
boot_mark:
		.word 0xAA55

.text
endtext:

!.data
!enddata:

!.bss
!endbss:

		end	
	
